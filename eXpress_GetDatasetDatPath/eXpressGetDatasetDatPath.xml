<tool id="eXpressGetDatasetDatPath" name="eXpressGetDatasetDatPath" version="0.01">
<description>get datfile-fullpath from eXpress output</description>

<command interpreter="python">

        eXpressGetDatasetDatPath.py --script_path "$runMe" --interpreter "python" 
            --tool_name "eXpressGetDatasetDatPath" --input_apikey "$input_apikey" --output_dir "./" --output_tab "$tab_file" 
</command>
<inputs>
<param name="job_name" type="text" label="Supply a name for the outputs to remind you what they contain" value="eXpressGetDatasetDatPath"/> 
<param name="input_apikey" type="text" label="Copy and Paste your API_KEY from Menu-bar[User]>[API keys]>[Current API key]" value="">
    <validator type="empty_field" message="No API_KEY is available for the input text form"/>
</param>
</inputs>
<outputs>
 <data format="tabular" name="tab_file" label="${job_name}"/>

</outputs>
<configfiles>
<configfile name="runMe">
# -*- coding: utf-8 -*-
import sys
import os
print "python :" + sys.version
import ConfigParser
sys.path.append('/usr/lib/python2.6/site-packages')
import dateutil.tz
import bioblend
from bioblend.galaxy import GalaxyInstance
from bioblend.galaxy.histories import HistoryClient
from bioblend.galaxy.datasets import DatasetClient
sys.path.append('/usr/lib64/python2.6/site-packages')
import pandas

print  os.getcwd()
print u"eXpress_GetDatasetDatPath.py Started......"

inp = sys.argv[1]
inp_apikey = sys.argv[2]
outp = sys.argv[3]
print u"inp: " + inp
print u"inp_apikey: " + inp_apikey
print u"outp: " + outp

if len(inp_apikey.strip()) == 0:
    raise Exception, ' API_KEY is not found.'

def findDatfilePath(dClient, h_list, hname):
    dset_list = [dset for dset in [dClient.show_dataset(hst['id']) for hst in h_list]
        if (dset['file_ext'] == 'txt' or dset['file_ext'] == 'tablur') and '.dat' in dset['file_name'] and 'target_id' in dset['peek']]
    dset_df = pandas.DataFrame(dset_list)
    #print dset_df.head(3)
    dset_path = dset_df[["hid","name","file_name"]]
    dset_path['History Name !!CAUTION!! If name is WRONG, Please logoff and login again.'] = hname
    print dset_path.head(3)
    return dset_path

def dataout(data, filename):
    data.to_csv(filename, sep="\t")

def main():
    GALAXY_URL = 'http://127.0.0.1:8080/'
    API_KEY = inp_apikey
    gInstance = GalaxyInstance(url=GALAXY_URL, key=API_KEY)
    hClient = HistoryClient(gInstance)
    dClient = DatasetClient(gInstance)

    hst = hClient.get_current_history()
    hst_cont_all = hClient.show_history(hst['id'], deleted=False, contents=True, visible=True, details=True)
    hst_cont_ok = [x for x in hst_cont_all if 'eXpress' in x['name'] and x['deleted'] == False and x['state'] == 'ok' ]
    if (len(hst_cont_ok) &gt; 0):
        path_list = findDatfilePath(dClient, hst_cont_ok, hst['name'])
        dataout(path_list, outp)
    else:
        print 'eXpress output &gt;&gt;&gt; not found.'

if __name__ == '__main__':
        main()

print u"....All Done. End of Script"
</configfile>
</configfiles>


        <tests>
        <test>
        <param name="input1" value="eXpressGetDatasetDatPath_test1_input.xls" ftype="None"/>
        <param name="job_name" value="test1"/>
        <param name="runMe" value="$runMe"/>
        <output name="tab_file" file="eXpressGetDatasetDatPath_test1_output.xls" ftype="tabular"/>
        </test>
        </tests>
        

<help>

This tool get fullpath and make tablur file from eXpress output results in current history.

**Attribution**
This Galaxy tool was created by mika.yoshimura@riken.jp at 30/01/2015 16:21:41
using the Galaxy Tool Factory.

See https://bitbucket.org/fubar/galaxytoolfactory for details of that project
Please cite: Creating re-usable tools from scripts: The Galaxy Tool Factory. Ross Lazarus; Antony Kaspi; Mark Ziemann; The Galaxy Team. 
Bioinformatics 2012; doi: 10.1093/bioinformatics/bts573

</help>
<citations>
    
    <citation type="doi">10.1093/bioinformatics/bts573</citation>
</citations>
</tool>
